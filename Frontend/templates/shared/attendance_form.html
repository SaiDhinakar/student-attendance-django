{% extends base_template|default:'shared/attendance_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/attendance-form.css' %}">
{% endblock %}

{% block content %}
<!-- Attendance Form Content -->
<div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
  <!-- Page Header -->
  <div class="text-center mb-8">
    <h1 class="text-2xl sm:text-3xl font-bold text-[var(--text-primary)] mb-3 flex items-center justify-center">
      <i class="iconoir-check-circle mr-2 text-[var(--accent)] text-2xl"></i>Mark Attendance
    </h1>
    <p class="text-[var(--text-secondary)] text-base sm:text-lg">Effortlessly record student attendance</p>
    {% if user_role == 'advisor' %}
    <p class="text-sm text-[var(--primary)] mt-2 flex items-center justify-center">
      <i class="iconoir-user-crown mr-1 text-[var(--primary)]"></i>Advisor: {{ user_department|default:"All Departments" }}
    </p>
    {% endif %}
    <div class="time-display mt-4 inline-block w-full sm:w-auto">
      <div class="text-sm opacity-90 flex items-center justify-center">
        <i class="iconoir-calendar mr-2"></i>{{ "now"|date:"F d, Y" }}
      </div>
      <div class="text-lg font-semibold flex items-center justify-center" id="currentTime">
        <i class="iconoir-clock mr-2"></i><span id="timeValue"></span>
      </div>
    </div>
  </div>

  <!-- Attendance Form -->
  <div class="form-container">
    <form id="attendanceForm" class="space-y-6">
      {% csrf_token %}

      <!-- Department Selection -->
      <div class="form-group">
        <label class="form-label flex items-center">
          <i class="iconoir-building mr-2 text-[var(--primary)]"></i>Department(s) <span class="text-[var(--accent)]">*</span>
        </label>
        <div class="department-container">
          <div id="departmentCheckboxes" class="department-checkboxes-scrollable"></div>
        </div>
        <div id="selectedDepartments" class="mt-3">
          <div class="text-sm text-[var(--text-secondary)] flex items-center">
            <i class="iconoir-check-square mr-1"></i>Selected: <span id="selectedDeptCount">0</span> department(s)
          </div>
          <div id="selectedDeptList" class="flex flex-wrap gap-2 mt-2"></div>
        </div>
      </div>

      <!-- Batch and Subject Selection -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="form-group">
          <label for="batch" class="form-label flex items-center">
            <i class="iconoir-group mr-2 text-[var(--primary)]"></i>Batch <span class="text-[var(--accent)]">*</span>
          </label>
          <select id="batch" name="batch" disabled class="form-select">
            <option value="">Select Batch</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subject" class="form-label flex items-center">
            <i class="iconoir-book mr-2 text-[var(--primary)]"></i>Subject <span class="text-[var(--accent)]">*</span>
          </label>
          <select id="subject" name="subject" disabled class="form-select">
            <option value="">Select Subject</option>
          </select>
        </div>
      </div>

      <!-- Section Selection -->
      <div class="form-group">
        <label class="form-label flex items-center">
          <i class="iconoir-list mr-2 text-[var(--primary)]"></i>Section(s)
        </label>
        <div id="sectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-2"></div>
        <div id="selectedSections" class="mt-3">
          <div class="text-sm text-[var(--text-secondary)] flex items-center">
            <i class="iconoir-check-square mr-1"></i>Selected: <span id="selectedSectionCount">0</span> section(s)
          </div>
          <div id="selectedSectionList" class="flex flex-wrap gap-2 mt-2"></div>
        </div>
      </div>

      <!-- Time Slot and Status -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="form-group">
          <label for="timeSlot" class="form-label flex items-center">
            <i class="iconoir-clock mr-2 text-[var(--primary)]"></i>Time Slot <span class="text-[var(--accent)]">*</span>
          </label>
          <select id="timeSlot" name="timeSlot" readonly class="form-select">
            <option value="">Auto-selecting time slot...</option>
          </select>
          <p class="text-xs text-[var(--text-secondary)] mt-1 flex items-center">
            <i class="iconoir-info-circle mr-1"></i>Auto-selected based on current time
          </p>
        </div>
        <div class="form-group">
          <label class="form-label flex items-center">
            <i class="iconoir-info-circle mr-2 text-[var(--primary)]"></i>Current Status
          </label>
          <div id="currentStatus" class="status-indicator status-inactive">
            <p class="text-sm flex items-center">
              <i class="iconoir-loading mr-2"></i>Loading status...
            </p>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="text-center mt-6">
        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
          <button type="submit" id="loadStudentsBtn" disabled class="btn-primary w-full sm:w-auto">
            <i class="iconoir-user-list mr-2"></i>Load Students (Manual)
          </button>
          <div class="text-sm text-[var(--text-secondary)]">or</div>
          <button type="button" id="cameraAttendanceBtn" disabled class="btn btn-secondary w-full sm:w-auto">
            <i class="iconoir-camera mr-2"></i>Take Attendance with Camera
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Students List -->
  <div id="studentsSection" class="form-container hidden mt-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6">
      <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4 sm:mb-0">Student Attendance</h2>
      <div id="attendanceStats" class="text-sm text-[var(--text-secondary)] text-center sm:text-right"></div>
    </div>

    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-3 mb-6">
      <button type="button" id="markAllPresent" class="btn-success flex-1 sm:flex-none">
        <i class="iconoir-check mr-1"></i>Mark All Present
      </button>
      <button type="button" id="markAllAbsent" class="btn-danger flex-1 sm:flex-none">
        <i class="iconoir-xmark mr-1"></i>Mark All Absent
      </button>
      <button type="button" id="clearAll" class="btn-secondary flex-1 sm:flex-none">
        <i class="iconoir-refresh mr-1"></i>Clear All
      </button>
    </div>

    <!-- Students Grid -->
    <div id="studentsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

    <!-- Submit Attendance -->
    <div class="text-center pt-6 border-t border-[var(--primary)]/20">
      <button type="button" id="submitAttendance" class="btn-primary w-full sm:w-auto">
        <i class="iconoir-send mr-2"></i>Submit Attendance
      </button>
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="fixed top-4 right-4 z-50 max-w-xs sm:max-w-sm"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // API configuration
  const API_BASE = '/api/attendance-form/';
  
  // Global variables for selected items
  let selectedDepartments = [];
  let selectedSections = [];
  let studentsData = [];

  // Update current time every second
  function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString("en-US", {
      hour12: false,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
    document.getElementById("timeValue").textContent = timeString;
  }

  updateCurrentTime();
  setInterval(updateCurrentTime, 1000);

  // Form elements
  const batchSelect = document.getElementById("batch");
  const subjectSelect = document.getElementById("subject");
  const timeSlotSelect = document.getElementById("timeSlot");
  const loadStudentsBtn = document.getElementById("loadStudentsBtn");
  const studentsSection = document.getElementById("studentsSection");
  const currentStatus = document.getElementById("currentStatus");

  // Utility functions
  function showError(elementId, message) {
    const errorEl = document.getElementById(elementId);
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
    showMessage(message, 'error');
  }

  function hideError(elementId) {
    const errorEl = document.getElementById(elementId);
    if (errorEl) {
      errorEl.style.display = 'none';
    }
  }

  function resetSelect(select, placeholder) {
    select.innerHTML = `<option value="">${placeholder}</option>`;
    select.disabled = true;
  }

  function enableSelect(select) {
    select.disabled = false;
  }

  // Enhanced form validation
  function validateFormData() {
    const errors = [];
    
    if (selectedDepartments.length === 0) {
      errors.push('Please select at least one department');
    }
    
    if (!batchSelect.value) {
      errors.push('Please select a batch');
    }
    
    if (!subjectSelect.value) {
      errors.push('Please select a subject');
    }
    
    if (!timeSlotSelect.value) {
      errors.push('No active time slot available');
    }
    
    return errors;
  }

  // Initialize the form
  function initializeForm() {
    // Check for failed submissions
    checkFailedSubmissions();
    
    // Try to restore form state
    const restored = restoreFormState();
    
    // Load initial data
    loadDepartments();
    
    // Add form change listeners for auto-save
    [batchSelect, subjectSelect].forEach(element => {
      if (element) {
        element.addEventListener('change', saveFormState);
      }
    });
    
    // Add visibility change listener to save state when user leaves
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        saveFormState();
      }
    });
    
    // Add beforeunload listener to save state
    window.addEventListener('beforeunload', function() {
      saveFormState();
    });
    
    // Setup resize observer for department container
    setupDepartmentResizeObserver();
    
    // Add window resize listener as fallback
    window.addEventListener('resize', function() {
      checkDepartmentScrollable();
    });
  }

  // Start initialization
  initializeForm();

  // Event listeners
  batchSelect.addEventListener("change", function () {
    const selectedBatch = this.value;
    if (selectedBatch && selectedDepartments.length > 0) {
      loadSubjects(selectedDepartments, selectedBatch);
      loadSections(selectedDepartments, selectedBatch);
      loadCurrentTimeSlot(selectedBatch);
    } else {
      resetSubjects();
      resetSections();
      resetTimeSlot();
      disableLoadButton();
    }
  });

  subjectSelect.addEventListener("change", function () {
    checkFormCompletion();
  });

  // Load departments and create checkboxes
  function loadDepartments() {
    fetch(`${API_BASE}?action=departments`)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("Departments data received:", data);
        if (data.departments && Array.isArray(data.departments)) {
          const container = document.getElementById("departmentCheckboxes");
          container.innerHTML = "";
          data.departments.forEach((dept) => {
            console.log("Processing department:", dept);
            const checkboxItem = createCheckboxItem(
              "department",
              dept.dept_name,  // Use dept_name instead of dept_id
              dept.dept_name,
              handleDepartmentChange
            );
            container.appendChild(checkboxItem);
          });
          
          // Check if container is scrollable and add appropriate class
          checkDepartmentScrollable();
          
          showMessage(`Loaded ${data.departments.length} departments`, "success");
        } else {
          console.error("Invalid departments data structure:", data);
          showMessage("No departments found or invalid data structure", "error");
        }
      })
      .catch((error) => {
        console.error("Error loading departments:", error);
        handleAPIError(error, "Loading departments");
      });
  }

  // Check if department container is scrollable
  function checkDepartmentScrollable() {
    const container = document.getElementById("departmentCheckboxes");
    if (container) {
      // Use setTimeout to ensure layout is complete
      setTimeout(() => {
        const isScrollable = container.scrollHeight > container.clientHeight;
        if (isScrollable) {
          container.classList.add("is-scrollable");
        } else {
          container.classList.remove("is-scrollable");
        }
      }, 100);
    }
  }

  // Setup resize observer for department container
  function setupDepartmentResizeObserver() {
    const container = document.getElementById("departmentCheckboxes");
    if (container && window.ResizeObserver) {
      const resizeObserver = new ResizeObserver(() => {
        checkDepartmentScrollable();
      });
      resizeObserver.observe(container);
    }
  }

  // Handle department checkbox changes
  function handleDepartmentChange(value, checked) {
    if (checked) {
      if (!selectedDepartments.includes(value)) {
        selectedDepartments.push(value);
      }
    } else {
      selectedDepartments = selectedDepartments.filter((dept) => dept !== value);
    }
    updateSelectedDepartmentsDisplay();
    if (selectedDepartments.length > 0) {
      loadBatches(selectedDepartments);
      resetSubjects();
      resetSections();
      resetTimeSlot();
      disableLoadButton();
    } else {
      resetBatches();
      resetSubjects();
      resetSections();
      resetTimeSlot();
      disableLoadButton();
    }
  }

  // Handle section checkbox changes
  function handleSectionChange(value, checked) {
    if (checked) {
      if (!selectedSections.includes(value)) {
        selectedSections.push(value);
      }
    } else {
      selectedSections = selectedSections.filter((section) => section !== value);
    }
    updateSelectedSectionsDisplay();
    checkFormCompletion();
  }

  // Create checkbox item
  function createCheckboxItem(name, value, label, changeHandler) {
    // Ensure value is a string before calling replace
    const stringValue = String(value);
    const safeValue = stringValue.replace(/[^a-zA-Z0-9]/g, "_");
    const div = document.createElement("div");
    div.className = "checkbox-item";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.name = name;
    checkbox.value = value;
    checkbox.id = `${name}_${safeValue}`;
    const labelEl = document.createElement("label");
    labelEl.setAttribute("for", checkbox.id);
    labelEl.textContent = label;
    div.appendChild(checkbox);
    div.appendChild(labelEl);
    checkbox.addEventListener("change", function () {
      changeHandler(value, this.checked);
      div.classList.toggle("checked", this.checked);
    });
    div.addEventListener("click", function (e) {
      if (e.target !== checkbox) {
        checkbox.click();
      }
    });
    return div;
  }

  // Update selected departments display
  function updateSelectedDepartmentsDisplay() {
    document.getElementById("selectedDeptCount").textContent = selectedDepartments.length;
    
    // Update department container visual feedback
    const departmentContainer = document.querySelector(".department-container");
    if (departmentContainer) {
      if (selectedDepartments.length > 0) {
        departmentContainer.classList.add("has-selections");
      } else {
        departmentContainer.classList.remove("has-selections");
      }
    }
    
    const listContainer = document.getElementById("selectedDeptList");
    listContainer.innerHTML = "";
    selectedDepartments.forEach((dept) => {
      const tag = document.createElement("span");
      tag.className = "tag removable";
      tag.textContent = dept;
      tag.addEventListener("click", function () {
        const safeDept = String(dept).replace(/[^a-zA-Z0-9]/g, "_");
        const checkbox = document.getElementById(`department_${safeDept}`);
        if (checkbox) {
          checkbox.click();
        }
      });
      listContainer.appendChild(tag);
    });
  }

  // Update selected sections display
  function updateSelectedSectionsDisplay() {
    document.getElementById("selectedSectionCount").textContent = selectedSections.length;
    const listContainer = document.getElementById("selectedSectionList");
    listContainer.innerHTML = "";
    selectedSections.forEach((section) => {
      const tag = document.createElement("span");
      tag.className = "tag removable";
      tag.textContent = section;
      tag.addEventListener("click", function () {
        const checkbox = document.getElementById(`section_${String(section).replace(/[^a-zA-Z0-9]/g, "_")}`);
        if (checkbox) {
          checkbox.click();
        }
      });
      listContainer.appendChild(tag);
    });
  }

  // Load batches for selected departments
  function loadBatches(deptNames) {
    const promises = deptNames.map((deptName) =>
      fetch(`${API_BASE}?action=batches&dept_id=${encodeURIComponent(deptName)}`)
        .then((response) => response.json())
    );
    Promise.all(promises)
      .then((results) => {
        const allBatches = [];
        results.forEach((data) => {
          if (data.batches) {
            data.batches.forEach((batch) => {
              if (!allBatches.find((b) => b.batch_year === batch.batch_year)) {
                allBatches.push(batch);
              }
            });
          }
        });
        batchSelect.innerHTML = '<option value="">Select Batch</option>';
        allBatches
          .sort((a, b) => a.batch_year - b.batch_year)
          .forEach((batch) => {
            const option = document.createElement("option");
            option.value = batch.batch_year;
            option.textContent = batch.display_year;
            batchSelect.appendChild(option);
          });
        batchSelect.disabled = false;
      })
      .catch((error) => {
        console.error("Error loading batches:", error);
        handleAPIError(error, "Loading batches");
      });
  }

  // Load subjects for selected departments and batch
  function loadSubjects(deptNames, batchYear) {
    const promises = deptNames.map((deptName) =>
      fetch(`${API_BASE}?action=subjects&dept_id=${encodeURIComponent(deptName)}&batch_year=${batchYear}`)
        .then((response) => response.json())
    );
    Promise.all(promises)
      .then((results) => {
        const allSubjects = [];
        results.forEach((data) => {
          if (data.subjects) {
            data.subjects.forEach((subject) => {
              if (!allSubjects.find((s) => s.subject_code === subject.subject_code)) {
                allSubjects.push(subject);
              }
            });
          }
        });
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        allSubjects
          .sort((a, b) => a.subject_name.localeCompare(b.subject_name))
          .forEach((subject) => {
            const option = document.createElement("option");
            option.value = subject.subject_code;
            option.textContent = `${subject.subject_code} - ${subject.subject_name}`;
            subjectSelect.appendChild(option);
          });
        subjectSelect.disabled = false;
      })
      .catch((error) => {
        console.error("Error loading subjects:", error);
        handleAPIError(error, "Loading subjects");
      });
  }

  // Load sections for selected departments and batch
  function loadSections(deptNames, batchYear) {
    selectedSections = [];
    updateSelectedSectionsDisplay();
    const container = document.getElementById("sectionCheckboxes");
    container.innerHTML = "";
    const sections = ["A", "B", "C"];
    deptNames.forEach((deptName) => {
      sections.forEach((sectionName) => {
        const sectionValue = `${deptName}-${sectionName}`;
        const sectionLabel = deptNames.length > 1 ? `Section ${sectionName} (${deptName})` : `Section ${sectionName}`;
        const checkboxItem = createCheckboxItem("section", sectionValue, sectionLabel, handleSectionChange);
        container.appendChild(checkboxItem);
      });
    });
  }

  // Load current time slot for selected batch
  function loadCurrentTimeSlot(batchYear) {
    fetch(`${API_BASE}?action=current_time_slot&batch_year=${batchYear}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.current_time_slot) {
          const timeSlot = data.current_time_slot;
          timeSlotSelect.innerHTML = `<option value="${timeSlot.block_number}" selected>Block ${timeSlot.block_number} (${timeSlot.start_time} - ${timeSlot.end_time})</option>`;
          const statusText = timeSlot.status === "active" ? "Class is currently active" : "Upcoming class";
          const statusClass = timeSlot.status === "active" ? "status-active" : "status-upcoming";
          currentStatus.className = `status-indicator ${statusClass}`;
          currentStatus.innerHTML = `<p class="text-sm flex items-center"><i class="iconoir-${timeSlot.status === 'active' ? 'play' : 'clock'} mr-2"></i>${statusText}</p><p class="text-xs opacity-75">Current time: ${data.current_time}</p>`;
        } else {
          timeSlotSelect.innerHTML = '<option value="">No active classes</option>';
          currentStatus.className = "status-indicator status-inactive";
          currentStatus.innerHTML = `<p class="text-sm flex items-center"><i class="iconoir-info-circle mr-2"></i>${data.message || "No classes scheduled"}</p><p class="text-xs opacity-75">Current time: ${data.current_time}</p>`;
        }
        checkFormCompletion();
      })
      .catch((error) => {
        console.error("Error loading time slot:", error);
        handleAPIError(error, "Loading time slot");
      });
  }

  // Reset functions
  function resetBatches() {
    batchSelect.innerHTML = '<option value="">Select Batch</option>';
    batchSelect.disabled = true;
  }

  function resetSubjects() {
    subjectSelect.innerHTML = '<option value="">Select Subject</option>';
    subjectSelect.disabled = true;
  }

  function resetSections() {
    selectedSections = [];
    updateSelectedSectionsDisplay();
    document.getElementById("sectionCheckboxes").innerHTML = "";
  }

  function resetTimeSlot() {
    timeSlotSelect.innerHTML = '<option value="">Auto-selecting time slot...</option>';
    currentStatus.className = "status-indicator status-inactive";
    currentStatus.innerHTML = '<p class="text-sm flex items-center">Loading status...</p>';
  }

  function disableLoadButton() {
    loadStudentsBtn.disabled = true;
  }

  function checkFormCompletion() {
    const batch = batchSelect.value;
    const subject = subjectSelect.value;
    const timeSlot = timeSlotSelect.value;
    const cameraAttendanceBtn = document.getElementById("cameraAttendanceBtn");
    
    if (selectedDepartments.length > 0 && batch && subject && timeSlot) {
      loadStudentsBtn.disabled = false;
      cameraAttendanceBtn.disabled = false;
    } else {
      loadStudentsBtn.disabled = true;
      cameraAttendanceBtn.disabled = true;
    }
  }

  // Load students button click
  loadStudentsBtn.addEventListener("click", function (e) {
    e.preventDefault();
    loadStudents();
  });

  // Camera attendance button click
  const cameraAttendanceBtn = document.getElementById("cameraAttendanceBtn");
  cameraAttendanceBtn.addEventListener("click", function (e) {
    e.preventDefault();
    openCameraAttendance();
  });

  // Open camera attendance page
  function openCameraAttendance() {
    const formData = {
      dept: selectedDepartments.join(','),
      batch: batchSelect.value,
      subject: subjectSelect.value,
      sections: selectedSections.length > 0 ? selectedSections.join(',') : "A",
      time: timeSlotSelect.value,
    };

    // Store in localStorage for the camera page
    localStorage.setItem('attendance_dept', formData.dept);
    localStorage.setItem('attendance_batch', formData.batch);
    localStorage.setItem('attendance_subject', formData.subject);
    localStorage.setItem('attendance_sections', formData.sections);
    localStorage.setItem('attendance_time', formData.time);

    // Build URL with parameters
    const params = new URLSearchParams(formData);
    window.location.href = `/staff/camera/?${params.toString()}`;
  }

  // Load students for attendance
  function loadStudents() {
    const formData = {
      departments: selectedDepartments,
      batch_year: batchSelect.value,
      subject: subjectSelect.value,
      sections: selectedSections.length > 0 ? selectedSections : ["A"],
      time_slot: timeSlotSelect.value,
    };
    
    // Show loading state
    loadStudentsBtn.disabled = true;
    loadStudentsBtn.innerHTML = '<i class="iconoir-loading animate-spin mr-2"></i>Loading Students...';
    
    studentsSection.classList.remove("hidden");
    
    // Try to fetch real students first, fallback to sample data
    fetchStudentsFromAPI(formData)
      .then(students => {
        if (students && students.length > 0) {
          renderStudents(students);
        } else {
          // If no students found, generate sample data
          generateSampleStudents(formData);
        }
      })
      .catch(error => {
        console.warn("Failed to load students from API:", error);
        // Fallback to sample data
        generateSampleStudents(formData);
      })
      .finally(() => {
        loadStudentsBtn.disabled = false;
        loadStudentsBtn.innerHTML = '<i class="iconoir-user-plus mr-2"></i>Load Students';
      });
  }

  // Fetch students from API
  async function fetchStudentsFromAPI(formData) {
    try {
      const params = new URLSearchParams({
        action: 'students',
        departments: formData.departments.join(','),
        batch_year: formData.batch_year,
        sections: formData.sections.join(',')
      });
      
      const response = await fetch(`${API_BASE}?${params}`);
      const data = await response.json();
      
      if (data.students) {
        return data.students;
      } else if (data.error) {
        throw new Error(data.error);
      } else {
        return [];
      }
    } catch (error) {
      console.error("Error fetching students:", error);
      throw error;
    }
  }

  // Render students list
  function renderStudents(students) {
    const studentsGrid = document.getElementById("studentsGrid");
    studentsGrid.innerHTML = "";
    
    if (students.length === 0) {
      studentsGrid.innerHTML = `
        <div class="col-span-full text-center py-8">
          <i class="iconoir-user-minus text-4xl text-[var(--text-secondary)] mb-4"></i>
          <p class="text-[var(--text-secondary)]">No students found for the selected criteria.</p>
        </div>
      `;
      return;
    }
    
    students.forEach((student) => {
      const studentCard = document.createElement("div");
      studentCard.className = "student-card";
      studentCard.dataset.studentId = student.id || student.student_id;
      studentCard.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
          <div class="mb-2 sm:mb-0">
            <h3 class="font-medium text-[var(--text-primary)]">${student.name}</h3>
            <p class="text-sm text-[var(--text-secondary)]">${student.register_number || student.rollNo}</p>
            <p class="text-xs text-[var(--text-secondary)]">${student.department || 'N/A'} - Section ${student.section}</p>
          </div>
          <div class="flex items-center space-x-2">
            <div class="attendance-status hidden">
              <i class="iconoir-check-circle text-[var(--accent)]"></i>
            </div>
          </div>
        </div>
        <div class="flex gap-3">
          <button type="button" class="attendance-btn present flex-1" data-student-id="${student.id || student.student_id}" data-status="present">
            <i class="iconoir-check mr-1"></i>Present
          </button>
          <button type="button" class="attendance-btn absent flex-1" data-student-id="${student.id || student.student_id}" data-status="absent">
            <i class="iconoir-xmark mr-1"></i>Absent
          </button>
        </div>
      `;
      studentsGrid.appendChild(studentCard);
    });
    
    addAttendanceEventListeners();
    updateAttendanceStats();
    
    // Show success message
    showMessage(`Loaded ${students.length} students successfully`, "success");
  }

  // Generate sample students (fallback)
  function generateSampleStudents(formData) {
    const studentsGrid = document.getElementById("studentsGrid");
    studentsGrid.innerHTML = "";
    const students = [];
    let studentId = 1;
    
    formData.departments.forEach((dept) => {
      const sectionsToUse = formData.sections.filter((s) => s.startsWith(dept) || formData.sections.length === 1);
      if (sectionsToUse.length === 0) sectionsToUse.push("A");
      
      sectionsToUse.forEach((sectionFull) => {
        const section = sectionFull.includes("-") ? sectionFull.split("-")[1] : sectionFull;
        for (let i = 1; i <= 5; i++) {
          students.push({
            id: studentId++,
            name: `Student ${String(i).padStart(2, "0")}`,
            rollNo: `21${dept.substring(0, 2).toUpperCase()}${section}${String(i).padStart(3, "0")}`,
            department: dept,
            section: section,
          });
        }
      });
    });
    
    renderStudents(students);
    showMessage("Sample student data loaded (API unavailable)", "warning");
  }

  // Add event listeners to attendance buttons
  function addAttendanceEventListeners() {
    document.querySelectorAll(".attendance-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const studentId = this.dataset.studentId;
        const status = this.dataset.status;
        const studentCard = this.closest(".student-card");
        studentCard.querySelectorAll(".attendance-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        this.classList.add("active");
        studentCard.dataset.attendance = status;
        updateAttendanceStats();
      });
    });
    document.getElementById("markAllPresent")?.addEventListener("click", function () {
      document.querySelectorAll(".attendance-btn.present").forEach((btn) => btn.click());
    });
    document.getElementById("markAllAbsent")?.addEventListener("click", function () {
      document.querySelectorAll(".attendance-btn.absent").forEach((btn) => btn.click());
    });
    document.getElementById("clearAll")?.addEventListener("click", function () {
      document.querySelectorAll(".attendance-btn").forEach((btn) => {
        btn.classList.remove("active");
      });
      document.querySelectorAll(".student-card[data-attendance]").forEach((card) => {
        delete card.dataset.attendance;
      });
      updateAttendanceStats();
    });
    document.getElementById("submitAttendance")?.addEventListener("click", function () {
      submitAttendance();
    });
  }

  // Submit attendance
  function submitAttendance() {
    // Validate that attendance has been marked for all students
    const totalStudents = document.querySelectorAll(".student-card").length;
    const markedStudents = document.querySelectorAll(".student-card[data-attendance]").length;
    
    if (totalStudents === 0) {
      showMessage("No students to submit attendance for", "error");
      return;
    }
    
    if (markedStudents === 0) {
      showMessage("Please mark attendance for at least one student", "error");
      return;
    }
    
    // Show confirmation dialog if some students are unmarked
    if (markedStudents < totalStudents) {
      const unmarkedCount = totalStudents - markedStudents;
      const confirmed = confirm(
        `${unmarkedCount} student(s) have not been marked. Unmarked students will be considered absent. Continue?`
      );
      if (!confirmed) return;
    }
    
    const attendanceData = {
      departments: selectedDepartments,
      batch_year: parseInt(batchSelect.value),
      subject: subjectSelect.value,
      sections: selectedSections.length > 0 ? selectedSections : ["A"],
      time_slot: parseInt(timeSlotSelect.value),
      date: new Date().toISOString().split('T')[0],
      attendance: [],
    };
    
    // Collect attendance data
    document.querySelectorAll(".student-card").forEach((card) => {
      const studentId = card.dataset.studentId;
      const status = card.dataset.attendance || "absent"; // Default to absent if not marked
      const studentName = card.querySelector("h3").textContent;
      const studentRoll = card.querySelector("p").textContent;
      
      attendanceData.attendance.push({
        student_id: studentId,
        student_name: studentName,
        register_number: studentRoll,
        status: status,
        is_present: status === "present"
      });
    });
    
    // Show loading state
    const submitBtn = document.getElementById("submitAttendance");
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="iconoir-loading animate-spin mr-2"></i>Submitting...';
    
    // Submit the attendance data
    fetch(`${API_BASE}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify(attendanceData),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (data.message || data.success) {
          const presentCount = attendanceData.attendance.filter(a => a.is_present).length;
          const absentCount = attendanceData.attendance.filter(a => !a.is_present).length;
          
          showMessage(
            `Attendance submitted successfully! ${presentCount} present, ${absentCount} absent`,
            "success"
          );
          
          // Store submission data for potential recovery
          localStorage.setItem('lastAttendanceSubmission', JSON.stringify({
            timestamp: new Date().toISOString(),
            data: attendanceData,
            response: data
          }));
          
          // Reset form after 3 seconds
          setTimeout(() => {
            if (confirm("Attendance submitted successfully! Would you like to reset the form for a new session?")) {
              location.reload();
            } else {
              // Re-enable the submit button for potential re-submission
              submitBtn.disabled = false;
              submitBtn.innerHTML = originalText;
            }
          }, 3000);
        } else {
          throw new Error(data.error || "Unknown error occurred");
        }
      })
      .catch((error) => {
        console.error("Error submitting attendance:", error);
        showMessage(`Error submitting attendance: ${error.message}`, "error");
        
        // Store failed submission for retry
        localStorage.setItem('failedAttendanceSubmission', JSON.stringify({
          timestamp: new Date().toISOString(),
          data: attendanceData,
          error: error.message
        }));
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
  }

  // Show message function
  function showMessage(message, type) {
    const messageContainer = document.getElementById("messageContainer");
    const messageDiv = document.createElement("div");
    
    // Define message styles based on type
    let bgColor, iconName;
    switch (type) {
      case "success":
        bgColor = "bg-[rgba(var(--accent-rgb),0.1)] border-[var(--accent)] text-[var(--accent)]";
        iconName = "check-circle";
        break;
      case "error":
        bgColor = "bg-[rgba(var(--danger-rgb),0.1)] border-[var(--danger)] text-[var(--danger)]";
        iconName = "warning-triangle";
        break;
      case "warning":
        bgColor = "bg-[rgba(var(--warning-rgb),0.1)] border-[var(--warning)] text-[var(--warning)]";
        iconName = "info-circle";
        break;
      case "info":
        bgColor = "bg-[rgba(var(--primary-rgb),0.1)] border-[var(--primary)] text-[var(--primary)]";
        iconName = "info-circle";
        break;
      default:
        bgColor = "bg-[rgba(var(--text-secondary-rgb),0.1)] border-[var(--text-secondary)] text-[var(--text-secondary)]";
        iconName = "info-circle";
    }
    
    messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-xs sm:max-w-sm border ${bgColor} animate-slide-in`;
    messageDiv.innerHTML = `
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="iconoir-${iconName} text-lg"></i>
        </div>
        <div class="ml-3 flex-1">
          <p class="text-sm font-medium">${message}</p>
        </div>
        <button class="ml-2 flex-shrink-0 hover:opacity-70 transition-opacity" onclick="this.parentElement.parentElement.remove()">
          <i class="iconoir-xmark text-lg"></i>
        </button>
      </div>
    `;
    
    messageContainer.appendChild(messageDiv);
    
    // Auto-remove after 5 seconds (7 seconds for errors)
    const timeout = type === "error" ? 7000 : 5000;
    setTimeout(() => {
      if (messageDiv.parentElement) {
        messageDiv.classList.add("animate-slide-out");
        setTimeout(() => messageDiv.remove(), 300);
      }
    }, timeout);
  }

  // Update attendance statistics
  function updateAttendanceStats() {
    const totalStudents = document.querySelectorAll(".student-card .attendance-btn[data-student-id]").length / 2;
    const presentCount = document.querySelectorAll('.student-card[data-attendance="present"]').length;
    const absentCount = document.querySelectorAll('.student-card[data-attendance="absent"]').length;
    const unmarkedCount = totalStudents - presentCount - absentCount;
    
    const attendanceStats = document.getElementById("attendanceStats");
    if (attendanceStats && totalStudents > 0) {
      const presentPercentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
      const absentPercentage = totalStudents > 0 ? Math.round((absentCount / totalStudents) * 100) : 0;
      
      attendanceStats.innerHTML = `
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center">
          <div class="bg-[rgba(var(--primary-rgb),0.1)] p-3 rounded-lg border border-[rgba(var(--primary-rgb),0.2)]">
            <div class="text-lg font-bold text-[var(--primary)]">${totalStudents}</div>
            <div class="text-xs text-[var(--primary)]/80 uppercase tracking-wide">Total</div>
          </div>
          <div class="bg-[rgba(var(--accent-rgb),0.1)] p-3 rounded-lg border border-[rgba(var(--accent-rgb),0.2)]">
            <div class="text-lg font-bold text-[var(--accent)]">${presentCount}</div>
            <div class="text-xs text-[var(--accent)]/80 uppercase tracking-wide">Present (${presentPercentage}%)</div>
          </div>
          <div class="bg-[rgba(var(--danger-rgb),0.1)] p-3 rounded-lg border border-[rgba(var(--danger-rgb),0.2)]">
            <div class="text-lg font-bold text-[var(--danger)]">${absentCount}</div>
            <div class="text-xs text-[var(--danger)]/80 uppercase tracking-wide">Absent (${absentPercentage}%)</div>
          </div>
          <div class="bg-[rgba(var(--text-secondary-rgb),0.1)] p-3 rounded-lg border border-[rgba(var(--text-secondary-rgb),0.2)]">
            <div class="text-lg font-bold text-[var(--text-secondary)]">${unmarkedCount}</div>
            <div class="text-xs text-[var(--text-secondary)]/80 uppercase tracking-wide">Unmarked</div>
          </div>
        </div>
      `;
    }
    
    // Enable/disable submit button based on marked attendance
    const submitBtn = document.getElementById("submitAttendance");
    if (submitBtn) {
      if (presentCount + absentCount > 0) {
        submitBtn.disabled = false;
        submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
      } else {
        submitBtn.disabled = true;
        submitBtn.classList.add("opacity-50", "cursor-not-allowed");
      }
    }
  }

  // Form validation helper
  function validateFormData() {
    const errors = [];
    
    if (selectedDepartments.length === 0) {
      errors.push("Please select at least one department");
    }
    
    if (!batchSelect.value) {
      errors.push("Please select a batch");
    }
    
    if (!subjectSelect.value) {
      errors.push("Please select a subject");
    }
    
    if (!timeSlotSelect.value) {
      errors.push("Please wait for time slot to load");
    }
    
    return errors;
  }

  // Auto-save form state
  function saveFormState() {
    const formState = {
      selectedDepartments,
      selectedSections,
      batch: batchSelect.value,
      subject: subjectSelect.value,
      timeSlot: timeSlotSelect.value,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('attendanceFormState', JSON.stringify(formState));
  }

  // Restore form state
  function restoreFormState() {
    try {
      const savedState = localStorage.getItem('attendanceFormState');
      if (savedState) {
        const formState = JSON.parse(savedState);
        
        // Check if saved state is recent (within last hour)
        const savedTime = new Date(formState.timestamp);
        const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
        
        if (savedTime > hourAgo) {
          // Restore form state
          if (formState.batch) {
            batchSelect.value = formState.batch;
          }
          if (formState.subject) {
            subjectSelect.value = formState.subject;
          }
          
          showMessage("Previous form state restored", "info");
          return true;
        }
      }
    } catch (error) {
      console.warn("Failed to restore form state:", error);
    }
    return false;
  }

  // Enhanced error handling for API calls
  function handleAPIError(error, context) {
    console.error(`API Error in ${context}:`, error);
    
    let message = "An unexpected error occurred";
    if (error.message.includes("NetworkError") || error.message.includes("fetch")) {
      message = "Network error - please check your connection";
    } else if (error.message.includes("401")) {
      message = "Authentication required - please log in again";
    } else if (error.message.includes("403")) {
      message = "Access denied - insufficient permissions";
    } else if (error.message.includes("404")) {
      message = "Resource not found";
    } else if (error.message.includes("500")) {
      message = "Server error - please try again later";
    }
    
    showMessage(`${context}: ${message}`, "error");
  }

  // Check for failed submissions on page load
  function checkFailedSubmissions() {
    const failed = localStorage.getItem('failedAttendanceSubmission');
    if (failed) {
      try {
        const failedData = JSON.parse(failed);
        const failedTime = new Date(failedData.timestamp);
        const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
        
        if (failedTime > hourAgo) {
          const retry = confirm(
            "A previous attendance submission failed. Would you like to retry it?"
          );
          
          if (retry) {
            // TODO: Implement retry mechanism
            showMessage("Retry functionality coming soon", "info");
          }
        }
        
        // Clean up old failed submissions
        localStorage.removeItem('failedAttendanceSubmission');
      } catch (error) {
        console.warn("Failed to parse failed submission data:", error);
        localStorage.removeItem('failedAttendanceSubmission');
      }
    }
  }
});
</script>
{% endblock %}