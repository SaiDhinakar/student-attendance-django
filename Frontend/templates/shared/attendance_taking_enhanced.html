{% extends "base.html" %}
{% load static %}

{% block title %}Take Attendance{% endblock %}

{% block extra_css %}
<style>
  .camera-container {
    position: relative;
    max-width: 640px;
    margin: 0 auto;
  }
  
  .camera-preview {
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .capture-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: var(--primary);
    border: 4px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .capture-btn:hover {
    transform: translateX(-50%) scale(1.1);
  }
  
  .preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .preview-content {
    background: var(--bg-primary);
    border-radius: 16px;
    padding: 24px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .captured-image {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  
  .student-card {
    background: var(--bg-secondary);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
  }
  
  .student-card.present {
    border-color: var(--success);
    background: rgba(34, 197, 94, 0.1);
  }
  
  .student-card.absent {
    border-color: var(--error);
    background: rgba(239, 68, 68, 0.1);
  }
  
  .confidence-bar {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
  }
  
  .confidence-fill {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s ease;
  }
  
  .processing-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    border-radius: 12px;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 20px;
  }
  
  .captured-image-thumb {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid var(--border);
    transition: all 0.3s ease;
  }
  
  .captured-image-thumb:hover {
    border-color: var(--primary);
    transform: scale(1.05);
  }
  
  .no-camera {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
  }
  
  .attendance-toggle-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
  }
  
  .attendance-toggle-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }
  
  .debug-console {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 200px;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    font-family: monospace;
    font-size: 12px;
    overflow-y: auto;
    padding: 10px;
    z-index: 9999;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }
  
  .debug-console.open {
    transform: translateY(0);
  }
  
  .debug-toggle {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-[var(--text-primary)] mb-2">
          <i class="iconoir-camera mr-3"></i>Take Attendance
        </h1>
        <p class="text-[var(--text-secondary)]">Capture images to automatically detect students</p>
      </div>
      <button id="backBtn" class="btn btn-secondary">
        <i class="iconoir-arrow-left mr-2"></i>Back
      </button>
    </div>
  </div>

  <!-- Session Info -->
  <div class="bg-[var(--bg-secondary)] rounded-xl p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Department</label>
        <p id="sessionDept" class="text-[var(--text-primary)] font-medium">-</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Batch Year</label>
        <p id="sessionBatch" class="text-[var(--text-primary)] font-medium">-</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Subject</label>
        <p id="sessionSubject" class="text-[var(--text-primary)] font-medium">-</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Time Slot</label>
        <p id="sessionTime" class="text-[var(--text-primary)] font-medium">-</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Camera Section -->
    <div class="space-y-6">
      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">
        <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4">
          <i class="iconoir-camera mr-2"></i>Camera
        </h2>
        
        <div class="camera-container">
          <video id="cameraVideo" class="camera-preview" autoplay playsinline></video>
          <canvas id="captureCanvas" style="display: none;"></canvas>
          <button id="captureBtn" class="capture-btn">
            <i class="iconoir-camera text-white text-2xl"></i>
          </button>
          <div id="processingOverlay" class="processing-overlay">
            <div class="text-center">
              <div class="spinner mb-4"></div>
              <p class="text-white">Processing images...</p>
            </div>
          </div>
          
          <div id="noCameraMessage" class="no-camera" style="display: none;">
            <i class="iconoir-camera-off text-4xl mb-4"></i>
            <p>Camera not available or permission denied</p>
            <button id="retryCamera" class="btn btn-primary mt-4">
              <i class="iconoir-refresh mr-2"></i>Retry
            </button>
          </div>
        </div>
      </div>

      <!-- Captured Images Gallery -->
      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">
        <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">
          <i class="iconoir-media-image mr-2"></i>Captured Images
        </h3>
        <div id="imageGallery" class="image-gallery">
          <!-- Captured images will be displayed here -->
        </div>
        <div id="noImagesMessage" class="text-center py-8 text-[var(--text-secondary)]">
          <i class="iconoir-media-image-plus text-4xl mb-2"></i>
          <p>No images captured yet</p>
        </div>
        
        <!-- Process All Images Button -->
        <div id="processImagesSection" class="mt-4" style="display: none;">
          <button id="processAllImagesBtn" class="btn btn-primary w-full">
            <i class="iconoir-brain mr-2"></i>Process All Images
          </button>
          <p class="text-sm text-[var(--text-secondary)] mt-2 text-center">
            Click to analyze all captured images for student detection
          </p>
        </div>
      </div>
    </div>

    <!-- Detected Students Section -->
    <div class="space-y-6">
      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-[var(--text-primary)]">
            <i class="iconoir-group mr-2"></i>Detected Students
          </h2>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-[var(--text-secondary)]">
              Total: <span id="totalStudents" class="font-medium">0</span>
            </span>
            <span class="text-sm text-[var(--success)]">
              Present: <span id="presentCount" class="font-medium">0</span>
            </span>
          </div>
        </div>
        
        <div id="detectedStudents" class="space-y-3 max-h-96 overflow-y-auto">
          <!-- Detected students will be displayed here -->
        </div>
        
        <div id="noStudentsMessage" class="text-center py-8 text-[var(--text-secondary)]">
          <i class="iconoir-user-circle text-4xl mb-2"></i>
          <p>No students detected yet</p>
          <p class="text-sm mt-2">Capture images to detect students</p>
        </div>
      </div>

      <!-- Actions -->
      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">
        <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">Actions</h3>
        <div class="space-y-3">
          <button id="markAllPresentBtn" class="btn btn-success w-full">
            <i class="iconoir-check-circle mr-2"></i>Mark All Present
          </button>
          <button id="markAllAbsentBtn" class="btn btn-error w-full">
            <i class="iconoir-cancel mr-2"></i>Mark All Absent
          </button>
          <button id="submitAttendanceBtn" class="btn btn-primary w-full" disabled>
            <i class="iconoir-send mr-2"></i>Submit Attendance
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="preview-modal">
  <div class="preview-content">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold text-[var(--text-primary)]">Image Preview & Results</h3>
      <button id="closeModal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
        <i class="iconoir-cancel text-2xl"></i>
      </button>
    </div>
    
    <div id="modalContent">
      <!-- Modal content will be dynamically populated -->
    </div>
  </div>
</div>

<!-- Debug Console -->
<div id="debugConsole" class="debug-console">
  <div class="font-bold mb-2">Debug Console</div>
  <div id="debugContent"></div>
</div>
<button id="debugToggle" class="debug-toggle">
  <i class="iconoir-terminal"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
class DebugLogger {
  constructor() {
    this.console = document.getElementById('debugContent');
    this.isEnabled = localStorage.getItem('debug_enabled') === 'true';
    this.maxLines = 100;
  }
  
  log(message, type = 'info') {
    if (!this.isEnabled) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const typeColors = {
      info: '#ffffff',
      success: '#10b981',
      error: '#ef4444',
      warning: '#f59e0b',
      debug: '#8b5cf6'
    };
    
    const color = typeColors[type] || typeColors.info;
    const logEntry = document.createElement('div');
    logEntry.style.color = color;
    logEntry.innerHTML = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
    
    this.console.appendChild(logEntry);
    
    // Keep only last N lines
    while (this.console.children.length > this.maxLines) {
      this.console.removeChild(this.console.firstChild);
    }
    
    // Auto-scroll to bottom
    this.console.scrollTop = this.console.scrollHeight;
    
    // Also log to browser console
    console.log(`[AttendanceApp] ${message}`);
  }
  
  enable() {
    this.isEnabled = true;
    localStorage.setItem('debug_enabled', 'true');
    this.log('Debug logging enabled', 'success');
  }
  
  disable() {
    this.isEnabled = false;
    localStorage.setItem('debug_enabled', 'false');
  }
  
  clear() {
    this.console.innerHTML = '';
  }
}

class AttendanceTaking {
  constructor() {
    this.video = document.getElementById('cameraVideo');
    this.canvas = document.getElementById('captureCanvas');
    this.ctx = this.canvas?.getContext('2d');
    this.capturedImages = [];
    this.detectedStudents = new Map();
    this.sessionData = this.getSessionData();
    this.sessionId = null;
    this.debug = new DebugLogger();
    
    this.init();
  }
  
  getSessionData() {
    this.debug.log('Getting session data from URL parameters and localStorage', 'debug');
    const urlParams = new URLSearchParams(window.location.search);
    const data = {
      department: urlParams.get('dept') || localStorage.getItem('attendance_dept') || '',
      batchYear: urlParams.get('batch') || localStorage.getItem('attendance_batch') || '',
      subject: urlParams.get('subject') || localStorage.getItem('attendance_subject') || '',
      timeSlot: urlParams.get('time') || localStorage.getItem('attendance_time') || '',
      sections: urlParams.get('sections') || localStorage.getItem('attendance_sections') || ''
    };
    
    this.debug.log(`Session data retrieved: ${JSON.stringify(data)}`, 'debug');
    return data;
  }
  
  async init() {
    this.debug.log('Initializing attendance taking interface', 'info');
    this.displaySessionInfo();
    this.setupEventListeners();
    await this.initCamera();
    this.debug.log('Initialization complete', 'success');
  }
  
  displaySessionInfo() {
    this.debug.log('Displaying session information in UI', 'debug');
    document.getElementById('sessionDept').textContent = this.sessionData.department || '-';
    document.getElementById('sessionBatch').textContent = this.sessionData.batchYear || '-';
    document.getElementById('sessionSubject').textContent = this.sessionData.subject || '-';
    document.getElementById('sessionTime').textContent = this.sessionData.timeSlot || '-';
  }
  
  setupEventListeners() {
    this.debug.log('Setting up event listeners', 'debug');
    
    // Camera controls
    document.getElementById('captureBtn')?.addEventListener('click', () => this.captureImage());
    document.getElementById('retryCamera')?.addEventListener('click', () => this.initCamera());
    
    // Navigation
    document.getElementById('backBtn')?.addEventListener('click', () => this.goBack());
    
    // Image processing
    document.getElementById('processAllImagesBtn')?.addEventListener('click', () => this.processAllImages());
    
    // Student management
    document.getElementById('markAllPresentBtn')?.addEventListener('click', () => this.markAllStudents(true));
    document.getElementById('markAllAbsentBtn')?.addEventListener('click', () => this.markAllStudents(false));
    document.getElementById('submitAttendanceBtn')?.addEventListener('click', () => this.submitAttendance());
    
    // Modal controls
    document.getElementById('closeModal')?.addEventListener('click', () => this.closeModal());
    document.getElementById('previewModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'previewModal') {
        this.closeModal();
      }
    });
    
    // Debug controls
    document.getElementById('debugToggle')?.addEventListener('click', () => this.toggleDebugConsole());
    
    this.debug.log('Event listeners setup complete', 'debug');
  }
  
  async initCamera() {
    this.debug.log('Initializing camera...', 'info');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      this.video.srcObject = stream;
      this.video.style.display = 'block';
      document.getElementById('noCameraMessage').style.display = 'none';
      this.debug.log('Camera initialized successfully', 'success');
    } catch (error) {
      this.debug.log(`Camera initialization failed: ${error.message}`, 'error');
      this.video.style.display = 'none';
      document.getElementById('noCameraMessage').style.display = 'block';
    }
  }
  
  captureImage() {
    this.debug.log('Capturing image from camera...', 'info');
    
    if (!this.canvas || !this.ctx) {
      this.debug.log('Canvas not available for image capture', 'error');
      return;
    }
    
    this.canvas.width = this.video.videoWidth;
    this.canvas.height = this.video.videoHeight;
    this.ctx.drawImage(this.video, 0, 0);
    
    const imageDataUrl = this.canvas.toDataURL('image/jpeg', 0.8);
    const imageBlob = this.dataURLtoBlob(imageDataUrl);
    
    const imageData = {
      id: Date.now(),
      dataUrl: imageDataUrl,
      blob: imageBlob,
      timestamp: new Date()
    };
    
    this.capturedImages.push(imageData);
    this.debug.log(`Image captured (ID: ${imageData.id}, Size: ${imageBlob.size} bytes)`, 'success');
    
    this.updateImageGallery();
    this.showNotification('Image captured successfully! Click "Process All Images" to analyze.', 'info');
  }
  
  dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
  }
  
  updateImageGallery() {
    this.debug.log(`Updating image gallery (${this.capturedImages.length} images)`, 'debug');
    
    const gallery = document.getElementById('imageGallery');
    const noImagesMessage = document.getElementById('noImagesMessage');
    const processSection = document.getElementById('processImagesSection');
    
    if (this.capturedImages.length === 0) {
      noImagesMessage.style.display = 'block';
      processSection.style.display = 'none';
      gallery.innerHTML = '';
      return;
    }
    
    noImagesMessage.style.display = 'none';
    processSection.style.display = 'block';
    
    gallery.innerHTML = this.capturedImages.map(img => `
      <img src="${img.dataUrl}" 
           class="captured-image-thumb" 
           onclick="attendanceTaking.showImagePreview(${img.id})"
           title="Captured at ${img.timestamp.toLocaleTimeString()}">
    `).join('');
  }
  
  async processAllImages() {
    if (this.capturedImages.length === 0) {
      this.debug.log('No images to process', 'warning');
      this.showNotification('No images captured yet', 'warning');
      return;
    }
    
    this.debug.log(`Starting batch processing of ${this.capturedImages.length} images`, 'info');
    
    const overlay = document.getElementById('processingOverlay');
    overlay.style.display = 'flex';
    
    try {
      // Prepare request data
      const imagesData = this.capturedImages.map(img => img.dataUrl);
      const requestData = {
        images_data: imagesData,
        dept_name: this.sessionData.department,
        batch_year: this.sessionData.batchYear,
        subject_code: this.sessionData.subject,
        sections: this.sessionData.sections,
        threshold: 0.45
      };
      
      this.debug.log(`Sending request to backend with data: ${JSON.stringify({
        ...requestData,
        images_data: `[${imagesData.length} images]`
      })}`, 'debug');
      
      const response = await fetch('/api/prediction/process-images/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCSRFToken()
        },
        body: JSON.stringify(requestData)
      });
      
      this.debug.log(`Received response: Status ${response.status}`, 'debug');
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      this.debug.log(`Processing result: ${JSON.stringify(result)}`, 'debug');
      
      if (result.success) {
        this.sessionId = result.session_id;
        this.debug.log(`Session ID set: ${this.sessionId}`, 'debug');
        this.handleImageProcessingResult(result);
        this.showNotification(result.message, 'success');
      } else {
        throw new Error(result.error || 'Failed to process images');
      }
      
    } catch (error) {
      this.debug.log(`Image processing error: ${error.message}`, 'error');
      this.showNotification('Error processing images. Please try again.', 'error');
    } finally {
      overlay.style.display = 'none';
    }
  }
  
  getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }
  
  handleImageProcessingResult(result) {
    this.debug.log('Processing image analysis results', 'debug');
    
    if (result.detected_students && result.detected_students.length > 0) {
      this.debug.log(`Processing ${result.detected_students.length} detected students`, 'debug');
      
      result.detected_students.forEach(student => {
        const registerNum = student.register_number;
        this.debug.log(`Processing student: ${registerNum} (${student.name})`, 'debug');
        
        if (!this.detectedStudents.has(registerNum)) {
          this.detectedStudents.set(registerNum, {
            register_number: registerNum,
            name: student.name,
            isPresent: student.is_present !== undefined ? student.is_present : true,
            confidence: student.confidence || 0,
            detectionCount: 1,
            predictionId: student.prediction_id
          });
          this.debug.log(`Added new student: ${registerNum}`, 'debug');
        } else {
          const existing = this.detectedStudents.get(registerNum);
          existing.detectionCount++;
          existing.confidence = Math.max(existing.confidence, student.confidence || 0);
          if (student.prediction_id) {
            existing.predictionId = student.prediction_id;
          }
          this.debug.log(`Updated existing student: ${registerNum} (detections: ${existing.detectionCount})`, 'debug');
        }
      });
      
      this.updateDetectedStudentsList();
      this.showNotification(`Processed images: ${result.detected_students.length} students detected`, 'success');
    } else {
      this.debug.log('No students detected in processed images', 'warning');
      this.showNotification('No students detected in the images', 'warning');
    }
  }
  
  updateDetectedStudentsList() {
    this.debug.log(`Updating detected students list (${this.detectedStudents.size} students)`, 'debug');
    
    const container = document.getElementById('detectedStudents');
    const noStudentsMessage = document.getElementById('noStudentsMessage');
    
    if (this.detectedStudents.size === 0) {
      noStudentsMessage.style.display = 'block';
      container.innerHTML = '';
      this.updateCounts();
      return;
    }
    
    noStudentsMessage.style.display = 'none';
    
    const studentsArray = Array.from(this.detectedStudents.values());
    container.innerHTML = studentsArray.map(student => this.createStudentCard(student)).join('');
    
    this.updateCounts();
    
    // Enable submit button if we have detected students
    document.getElementById('submitAttendanceBtn').disabled = this.detectedStudents.size === 0;
  }
  
  createStudentCard(student) {
    const statusClass = student.isPresent ? 'present' : 'absent';
    const statusIcon = student.isPresent ? 'iconoir-check-circle' : 'iconoir-cancel';
    const statusText = student.isPresent ? 'Present' : 'Absent';
    
    return `
      <div class="student-card ${statusClass}" data-student="${student.register_number}">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h4 class="font-medium text-[var(--text-primary)]">${student.name}</h4>
            <p class="text-sm text-[var(--text-secondary)]">${student.register_number}</p>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: ${(student.confidence * 100).toFixed(1)}%"></div>
            </div>
            <p class="text-xs text-[var(--text-secondary)] mt-1">
              Confidence: ${(student.confidence * 100).toFixed(1)}% (${student.detectionCount} detection${student.detectionCount > 1 ? 's' : ''})
            </p>
          </div>
          <div class="flex items-center space-x-2 ml-4">
            <button class="attendance-toggle-btn" onclick="attendanceTaking.toggleStudentStatus('${student.register_number}')">
              <i class="${statusIcon} text-xl"></i>
            </button>
          </div>
        </div>
        <div class="mt-2 text-right">
          <span class="text-sm font-medium ${student.isPresent ? 'text-[var(--success)]' : 'text-[var(--error)]'}">
            ${statusText}
          </span>
        </div>
      </div>
    `;
  }
  
  toggleStudentStatus(registerNumber) {
    this.debug.log(`Toggling status for student: ${registerNumber}`, 'debug');
    const student = this.detectedStudents.get(registerNumber);
    if (student) {
      student.isPresent = !student.isPresent;
      this.updateDetectedStudentsList();
      this.debug.log(`Student ${registerNumber} status changed to: ${student.isPresent ? 'Present' : 'Absent'}`, 'debug');
    }
  }
  
  markAllStudents(isPresent) {
    this.debug.log(`Marking all students as ${isPresent ? 'present' : 'absent'}`, 'info');
    this.detectedStudents.forEach(student => {
      student.isPresent = isPresent;
    });
    this.updateDetectedStudentsList();
  }
  
  updateCounts() {
    const total = this.detectedStudents.size;
    const present = Array.from(this.detectedStudents.values()).filter(s => s.isPresent).length;
    
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = present;
  }
  
  showImagePreview(imageId) {
    this.debug.log(`Showing preview for image ID: ${imageId}`, 'debug');
    const image = this.capturedImages.find(img => img.id === imageId);
    if (!image) return;
    
    const modal = document.getElementById('previewModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
      <img src="${image.dataUrl}" class="captured-image" alt="Captured image">
      <div class="text-center">
        <p class="text-[var(--text-secondary)]">Captured at ${image.timestamp.toLocaleString()}</p>
        <button onclick="attendanceTaking.deleteImage(${imageId})" class="btn btn-error mt-4">
          <i class="iconoir-trash mr-2"></i>Delete Image
        </button>
      </div>
    `;
    
    modal.style.display = 'flex';
  }
  
  deleteImage(imageId) {
    this.debug.log(`Deleting image ID: ${imageId}`, 'info');
    this.capturedImages = this.capturedImages.filter(img => img.id !== imageId);
    this.updateImageGallery();
    this.closeModal();
  }
  
  closeModal() {
    document.getElementById('previewModal').style.display = 'none';
  }
  
  async submitAttendance() {
    if (this.detectedStudents.size === 0) {
      this.debug.log('No students to submit', 'warning');
      this.showNotification('No students detected to submit', 'warning');
      return;
    }
    
    if (!this.sessionId) {
      this.debug.log('No session ID available for submission', 'error');
      this.showNotification('No session ID found. Please process images first.', 'error');
      return;
    }
    
    this.debug.log(`Submitting attendance for ${this.detectedStudents.size} students`, 'info');
    
    const submitBtn = document.getElementById('submitAttendanceBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="iconoir-loading animate-spin mr-2"></i>Submitting...';
    
    try {
      const attendanceData = {
        session_id: this.sessionId,
        submitted_by: 'staff_user', // TODO: Get actual username from session
        attendance: Array.from(this.detectedStudents.values()).map(student => ({
          register_number: student.register_number,
          is_present: student.isPresent,
          confidence: student.confidence
        }))
      };
      
      this.debug.log(`Submitting attendance data: ${JSON.stringify(attendanceData)}`, 'debug');
      
      const response = await fetch('/api/prediction/submit-attendance/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCSRFToken()
        },
        body: JSON.stringify(attendanceData)
      });
      
      this.debug.log(`Submission response: Status ${response.status}`, 'debug');
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      this.debug.log(`Submission result: ${JSON.stringify(result)}`, 'debug');
      
      if (result.success) {
        this.debug.log('Attendance submitted successfully', 'success');
        this.showNotification(
          `Attendance submitted successfully! ${result.submissions_count} students processed, ${result.edited_count} manually edited.`, 
          'success'
        );
        setTimeout(() => {
          this.goBack();
        }, 2000);
      } else {
        throw new Error(result.error || 'Failed to submit attendance');
      }
      
    } catch (error) {
      this.debug.log(`Submission error: ${error.message}`, 'error');
      this.showNotification('Error submitting attendance. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }
  
  goBack() {
    this.debug.log('Navigating back to previous page', 'info');
    window.history.back();
  }
  
  toggleDebugConsole() {
    const console = document.getElementById('debugConsole');
    const isOpen = console.classList.contains('open');
    
    if (isOpen) {
      console.classList.remove('open');
      this.debug.disable();
    } else {
      console.classList.add('open');
      this.debug.enable();
    }
  }
  
  showNotification(message, type = 'info') {
    this.debug.log(`Notification: ${message} (${type})`, 'debug');
    
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
    
    const colors = {
      success: 'bg-green-500 text-white',
      error: 'bg-red-500 text-white',
      warning: 'bg-yellow-500 text-black',
      info: 'bg-blue-500 text-white'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 5 seconds
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 5000);
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  window.attendanceTaking = new AttendanceTaking();
});
</script>
{% endblock %}
