{% extends "base.html" %}
{% load static %}

{% block title %}Take Attendance{% endblock %}

{% block extra_css %}<style>  .camera-container {    position: relative;    max-width: 640px;    margin: 0 auto;  }    .camera-preview {    width: 100%;    height: auto;    border-radius: 12px;    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);  }    .capture-btn {    position: absolute;    bottom: 20px;    left: 50%;    transform: translateX(-50%);    width: 70px;    height: 70px;    border-radius: 50%;    background: var(--primary);    border: 4px solid white;    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);    cursor: pointer;    transition: all 0.3s ease;    display: flex;    align-items: center;    justify-content: center;  }    .capture-btn:hover {    transform: translateX(-50%) scale(1.1);  }    .preview-modal {    position: fixed;    top: 0;    left: 0;    width: 100%;    height: 100%;    background: rgba(0, 0, 0, 0.8);    display: none;    justify-content: center;    align-items: center;    z-index: 1000;  }    .preview-content {    background: var(--bg-primary);    border-radius: 16px;    padding: 24px;    max-width: 90vw;    max-height: 90vh;    overflow-y: auto;  }    .captured-image {    max-width: 100%;    height: auto;    border-radius: 12px;    margin-bottom: 20px;  }    .student-card {    background: var(--bg-secondary);    border: 2px solid var(--border);    border-radius: 12px;    padding: 16px;    margin-bottom: 12px;    transition: all 0.3s ease;  }    .student-card.present {    border-color: var(--success);    background: rgba(34, 197, 94, 0.1);  }    .student-card.absent {    border-color: var(--error);    background: rgba(239, 68, 68, 0.1);  }    .confidence-bar {    width: 100%;    height: 6px;    background: var(--border);    border-radius: 3px;    overflow: hidden;    margin-top: 8px;  }    .confidence-fill {    height: 100%;    background: var(--primary);    transition: width 0.3s ease;  }    .processing-overlay {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;    background: rgba(0, 0, 0, 0.7);    display: none;    justify-content: center;    align-items: center;    border-radius: 12px;  }    .spinner {    width: 40px;    height: 40px;    border: 4px solid rgba(255, 255, 255, 0.3);    border-top: 4px solid white;    border-radius: 50%;    animation: spin 1s linear infinite;  }    @keyframes spin {    0% { transform: rotate(0deg); }    100% { transform: rotate(360deg); }  }    .image-gallery {    display: grid;    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));    gap: 12px;    margin-top: 20px;  }    .captured-image-thumb {    width: 100%;    height: 120px;    object-fit: cover;    border-radius: 8px;    cursor: pointer;    border: 2px solid var(--border);    transition: all 0.3s ease;  }    .captured-image-thumb:hover {    border-color: var(--primary);    transform: scale(1.05);  }    .no-camera {    text-align: center;    padding: 40px;    color: var(--text-secondary);  }    .attendance-toggle-btn {    background: none;    border: none;    cursor: pointer;    padding: 8px;    border-radius: 50%;    transition: background-color 0.3s ease;  }    .attendance-toggle-btn:hover {    background: rgba(0, 0, 0, 0.1);  }
</style>
{% endblock %}

{% block content %}<div class="container mx-auto px-4 py-8">  <!-- Header -->  <div class="mb-8">    <div class="flex items-center justify-between">      <div>        <h1 class="text-3xl font-bold text-[var(--text-primary)] mb-2">          <i class="iconoir-camera mr-3"></i>Take Attendance        </h1>        <p class="text-[var(--text-secondary)]">Capture images to automatically detect students</p>      </div>      <button id="backBtn" class="btn btn-secondary">        <i class="iconoir-arrow-left mr-2"></i>Back      </button>    </div>  </div>  <!-- Session Info -->  <div class="bg-[var(--bg-secondary)] rounded-xl p-6 mb-8">    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">      <div>        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Department</label>        <p id="sessionDept" class="text-[var(--text-primary)] font-medium">-</p>      </div>      <div>        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Batch Year</label>        <p id="sessionBatch" class="text-[var(--text-primary)] font-medium">-</p>      </div>      <div>        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Subject</label>        <p id="sessionSubject" class="text-[var(--text-primary)] font-medium">-</p>      </div>      <div>        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Time Slot</label>        <p id="sessionTime" class="text-[var(--text-primary)] font-medium">-</p>      </div>    </div>  </div>  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">    <!-- Camera Section -->    <div class="space-y-6">      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">        <h2 class="text-xl font-semibold text-[var(--text-primary)] mb-4">          <i class="iconoir-camera mr-2"></i>Camera        </h2>                <div class="camera-container">          <video id="cameraVideo" class="camera-preview" autoplay playsinline></video>          <canvas id="captureCanvas" style="display: none;"></canvas>          <button id="captureBtn" class="capture-btn">            <i class="iconoir-camera text-white text-2xl"></i>          </button>          <div id="processingOverlay" class="processing-overlay">            <div class="text-center">              <div class="spinner mb-4"></div>              <p class="text-white">Processing image...</p>            </div>          </div>                    <div id="noCameraMessage" class="no-camera" style="display: none;">            <i class="iconoir-camera-off text-4xl mb-4"></i>            <p>Camera not available or permission denied</p>            <button id="retryCamera" class="btn btn-primary mt-4">              <i class="iconoir-refresh mr-2"></i>Retry            </button>          </div>        </div>      </div>      <!-- Captured Images Gallery -->      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">        <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">          <i class="iconoir-media-image mr-2"></i>Captured Images        </h3>        <div id="imageGallery" class="image-gallery">          <!-- Captured images will be displayed here -->        </div>        <div id="noImagesMessage" class="text-center py-8 text-[var(--text-secondary)]">          <i class="iconoir-media-image-plus text-4xl mb-2"></i>          <p>No images captured yet</p>        </div>      </div>    </div>    <!-- Detected Students Section -->    <div class="space-y-6">      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">        <div class="flex items-center justify-between mb-4">          <h2 class="text-xl font-semibold text-[var(--text-primary)]">            <i class="iconoir-group mr-2"></i>Detected Students          </h2>          <div class="flex items-center space-x-4">            <span class="text-sm text-[var(--text-secondary)]">              Total: <span id="totalStudents" class="font-medium">0</span>            </span>            <span class="text-sm text-[var(--success)]">              Present: <span id="presentCount" class="font-medium">0</span>            </span>          </div>        </div>                <div id="detectedStudents" class="space-y-3 max-h-96 overflow-y-auto">          <!-- Detected students will be displayed here -->        </div>                <div id="noStudentsMessage" class="text-center py-8 text-[var(--text-secondary)]">          <i class="iconoir-user-circle text-4xl mb-2"></i>          <p>No students detected yet</p>          <p class="text-sm mt-2">Capture images to detect students</p>        </div>      </div>      <!-- Actions -->      <div class="bg-[var(--bg-secondary)] rounded-xl p-6">        <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">Actions</h3>        <div class="space-y-3">          <button id="markAllPresentBtn" class="btn btn-success w-full">            <i class="iconoir-check-circle mr-2"></i>Mark All Present          </button>          <button id="markAllAbsentBtn" class="btn btn-error w-full">            <i class="iconoir-cancel mr-2"></i>Mark All Absent          </button>          <button id="submitAttendanceBtn" class="btn btn-primary w-full" disabled>            <i class="iconoir-send mr-2"></i>Submit Attendance          </button>        </div>      </div>    </div>  </div></div><!-- Preview Modal --><div id="previewModal" class="preview-modal">  <div class="preview-content">    <div class="flex items-center justify-between mb-4">      <h3 class="text-xl font-semibold text-[var(--text-primary)]">Image Preview & Results</h3>      <button id="closeModal" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">        <i class="iconoir-cancel text-2xl"></i>      </button>    </div>        <div id="modalContent">      <!-- Modal content will be dynamically populated -->    </div>  </div>
</div>
{% endblock %}

{% block extra_js %}<script>class AttendanceTaking {  constructor() {    this.video = document.getElementById('cameraVideo');    this.canvas = document.getElementById('captureCanvas');    this.ctx = this.canvas?.getContext('2d');    this.capturedImages = [];    this.detectedStudents = new Map();
    this.sessionData = this.getSessionData();
    
    this.init();
  }
  
  getSessionData() {
    // Get session data from URL parameters or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    return {
      department: urlParams.get('dept') || localStorage.getItem('attendance_dept') || '',
      batchYear: urlParams.get('batch') || localStorage.getItem('attendance_batch') || '',
      subject: urlParams.get('subject') || localStorage.getItem('attendance_subject') || '',
      timeSlot: urlParams.get('time') || localStorage.getItem('attendance_time') || '',
      sections: urlParams.get('sections') || localStorage.getItem('attendance_sections') || ''
    };
  }
  
  async init() {
    this.displaySessionInfo();
    this.setupEventListeners();
    await this.initCamera();
  }
  
  displaySessionInfo() {
    document.getElementById('sessionDept').textContent = this.sessionData.department || '-';
    document.getElementById('sessionBatch').textContent = this.sessionData.batchYear || '-';
    document.getElementById('sessionSubject').textContent = this.sessionData.subject || '-';
    document.getElementById('sessionTime').textContent = this.sessionData.timeSlot || '-';
  }
  
  setupEventListeners() {
    document.getElementById('captureBtn')?.addEventListener('click', () => this.captureImage());
    document.getElementById('backBtn')?.addEventListener('click', () => this.goBack());
    document.getElementById('retryCamera')?.addEventListener('click', () => this.initCamera());
    document.getElementById('closeModal')?.addEventListener('click', () => this.closeModal());
    document.getElementById('markAllPresentBtn')?.addEventListener('click', () => this.markAllStudents(true));
    document.getElementById('markAllAbsentBtn')?.addEventListener('click', () => this.markAllStudents(false));
    document.getElementById('submitAttendanceBtn')?.addEventListener('click', () => this.submitAttendance());
    
    // Close modal when clicking outside
    document.getElementById('previewModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'previewModal') {
        this.closeModal();
      }
    });
  }
  
  async initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      this.video.srcObject = stream;
      this.video.style.display = 'block';
      document.getElementById('noCameraMessage').style.display = 'none';
    } catch (error) {
      console.error('Error accessing camera:', error);
      this.video.style.display = 'none';
      document.getElementById('noCameraMessage').style.display = 'block';
    }
  }
  
  captureImage() {
    if (!this.canvas || !this.ctx) return;
    
    this.canvas.width = this.video.videoWidth;
    this.canvas.height = this.video.videoHeight;
    this.ctx.drawImage(this.video, 0, 0);
    
    const imageDataUrl = this.canvas.toDataURL('image/jpeg', 0.8);
    const imageBlob = this.dataURLtoBlob(imageDataUrl);
    
    this.capturedImages.push({
      id: Date.now(),
      dataUrl: imageDataUrl,
      blob: imageBlob,
      timestamp: new Date()
    });
    
    this.updateImageGallery();
    this.processImage(imageBlob);
  }
  
  dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
  }
  
  updateImageGallery() {
    const gallery = document.getElementById('imageGallery');
    const noImagesMessage = document.getElementById('noImagesMessage');
    
    if (this.capturedImages.length === 0) {
      noImagesMessage.style.display = 'block';
      gallery.innerHTML = '';
      return;
    }
    
    noImagesMessage.style.display = 'none';
    gallery.innerHTML = this.capturedImages.map(img => `
      <img src="${img.dataUrl}" 
           class="captured-image-thumb" 
           onclick="attendanceTaking.showImagePreview(${img.id})"
           title="Captured at ${img.timestamp.toLocaleTimeString()}">
    `).join('');
  }
  
  async processImage(imageBlob) {
    const overlay = document.getElementById('processingOverlay');
    overlay.style.display = 'flex';
    
    try {
      // For now, just simulate processing since we don't have the actual API yet
      this.showNotification('Image processing not yet implemented. This is a placeholder.', 'warning');
      
      // Simulate some detected students for testing
      const mockStudents = [
        {
          register_number: '2027CS001',
          name: 'John Doe',
          confidence: 0.85
        },
        {
          register_number: '2027CS002',
          name: 'Jane Smith',
          confidence: 0.92
        }
      ];
      
      // Simulate processing delay
      setTimeout(() => {
        this.handleImageProcessingResult({ detected_students: mockStudents });
      }, 1500);
      
    } catch (error) {
      console.error('Error processing image:', error);
      this.showNotification('Error processing image. Please try again.', 'error');
    } finally {
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 1500);
    }
  }
  
  getSectionId() {
    // This should be derived from the session data
    // For now, return a default value or implement section lookup
    return 1;
  }
  
  getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  }
  
  handleImageProcessingResult(result) {
    if (result.detected_students && result.detected_students.length > 0) {
      result.detected_students.forEach(student => {
        if (!this.detectedStudents.has(student.register_number)) {
          this.detectedStudents.set(student.register_number, {
            ...student,
            isPresent: true,
            confidence: student.confidence || 0,
            detectionCount: 1
          });
        } else {
          // Update existing student
          const existing = this.detectedStudents.get(student.register_number);
          existing.detectionCount++;
          existing.confidence = Math.max(existing.confidence, student.confidence || 0);
        }
      });
      
      this.updateDetectedStudentsList();
      this.showNotification(`Detected ${result.detected_students.length} students in the image`, 'success');
    } else {
      this.showNotification('No students detected in the image', 'warning');
    }
  }
  
  updateDetectedStudentsList() {
    const container = document.getElementById('detectedStudents');
    const noStudentsMessage = document.getElementById('noStudentsMessage');
    
    if (this.detectedStudents.size === 0) {
      noStudentsMessage.style.display = 'block';
      container.innerHTML = '';
      this.updateCounts();
      return;
    }
    
    noStudentsMessage.style.display = 'none';
    
    const studentsArray = Array.from(this.detectedStudents.values());
    container.innerHTML = studentsArray.map(student => this.createStudentCard(student)).join('');
    
    this.updateCounts();
    
    // Enable submit button if we have detected students
    document.getElementById('submitAttendanceBtn').disabled = this.detectedStudents.size === 0;
  }
  
  createStudentCard(student) {
    const statusClass = student.isPresent ? 'present' : 'absent';
    const statusIcon = student.isPresent ? 'iconoir-check-circle' : 'iconoir-cancel';
    const statusText = student.isPresent ? 'Present' : 'Absent';
    
    return `
      <div class="student-card ${statusClass}" data-student="${student.register_number}">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h4 class="font-medium text-[var(--text-primary)]">${student.name}</h4>
            <p class="text-sm text-[var(--text-secondary)]">${student.register_number}</p>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: ${(student.confidence * 100).toFixed(1)}%"></div>
            </div>
            <p class="text-xs text-[var(--text-secondary)] mt-1">
              Confidence: ${(student.confidence * 100).toFixed(1)}% (${student.detectionCount} detection${student.detectionCount > 1 ? 's' : ''})
            </p>
          </div>
          <div class="flex items-center space-x-2 ml-4">
            <button class="attendance-toggle-btn" onclick="attendanceTaking.toggleStudentStatus('${student.register_number}')">
              <i class="${statusIcon} text-xl"></i>
            </button>
          </div>
        </div>
        <div class="mt-2 text-right">
          <span class="text-sm font-medium ${student.isPresent ? 'text-[var(--success)]' : 'text-[var(--error)]'}">
            ${statusText}
          </span>
        </div>
      </div>
    `;
  }
  
  toggleStudentStatus(registerNumber) {
    const student = this.detectedStudents.get(registerNumber);
    if (student) {
      student.isPresent = !student.isPresent;
      this.updateDetectedStudentsList();
    }
  }
  
  markAllStudents(isPresent) {
    this.detectedStudents.forEach(student => {
      student.isPresent = isPresent;
    });
    this.updateDetectedStudentsList();
  }
  
  updateCounts() {
    const total = this.detectedStudents.size;
    const present = Array.from(this.detectedStudents.values()).filter(s => s.isPresent).length;
    
    document.getElementById('totalStudents').textContent = total;
    document.getElementById('presentCount').textContent = present;
  }
  
  showImagePreview(imageId) {
    const image = this.capturedImages.find(img => img.id === imageId);
    if (!image) return;
    
    const modal = document.getElementById('previewModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
      <img src="${image.dataUrl}" class="captured-image" alt="Captured image">
      <div class="text-center">
        <p class="text-[var(--text-secondary)]">Captured at ${image.timestamp.toLocaleString()}</p>
        <button onclick="attendanceTaking.deleteImage(${imageId})" class="btn btn-error mt-4">
          <i class="iconoir-trash mr-2"></i>Delete Image
        </button>
      </div>
    `;
    
    modal.style.display = 'flex';
  }
  
  deleteImage(imageId) {
    this.capturedImages = this.capturedImages.filter(img => img.id !== imageId);
    this.updateImageGallery();
    this.closeModal();
  }
  
  closeModal() {
    document.getElementById('previewModal').style.display = 'none';
  }
  
  async submitAttendance() {
    if (this.detectedStudents.size === 0) {
      this.showNotification('No students detected to submit', 'warning');
      return;
    }
    
    const submitBtn = document.getElementById('submitAttendanceBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="iconoir-loading animate-spin mr-2"></i>Submitting...';
    
    try {
      const attendanceData = {
        dept_name: this.sessionData.department,
        batch_year: this.sessionData.batchYear,
        subject: this.sessionData.subject,
        time_slot: this.sessionData.timeSlot,
        attendance: Array.from(this.detectedStudents.values()).map(student => ({
          student_id: student.register_number,
          student_name: student.name,
          register_number: student.register_number,
          status: student.isPresent ? 'present' : 'absent',
          is_present: student.isPresent,
          confidence: student.confidence,
          detection_method: 'camera'
        }))
      };
      
      const response = await fetch('/api/attendance-form/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': this.getCSRFToken()
        },
        body: JSON.stringify(attendanceData)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        this.showNotification('Attendance submitted successfully!', 'success');
        setTimeout(() => {
          this.goBack();
        }, 2000);
      } else {
        throw new Error(result.error || 'Failed to submit attendance');
      }
      
    } catch (error) {
      console.error('Error submitting attendance:', error);
      this.showNotification('Error submitting attendance. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }
  
  goBack() {
    window.history.back();
  }
  
  showNotification(message, type = 'info') {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
    
    const colors = {
      success: 'bg-green-500 text-white',
      error: 'bg-red-500 text-white',
      warning: 'bg-yellow-500 text-black',
      info: 'bg-blue-500 text-white'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 5 seconds
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 5000);
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  window.attendanceTaking = new AttendanceTaking();
});
</script>
{% endblock %}
