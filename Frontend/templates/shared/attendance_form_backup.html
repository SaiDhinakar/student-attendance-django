{% extends 'shared/attendance_base.html' %}
{% load static %}

{% block title %}Mark Attendance - Student Attendance System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/attendance-form-backup.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-primary-custom mb-2">
      Mark Attendance
    </h1>
    <p class="text-secondary-custom text-lg">
      Select course details to mark student attendance
    </p>
  </div>

  <!-- Attendance Form -->
  <div class="form-container">
    <div class="form-card">
      <form id="attendanceForm">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Department Selection -->
          <div class="form-group">
            <label for="department" class="form-label">
              <i class="iconoir-building mr-2"></i>Department
            </label>
            <select id="department" name="department" class="form-select" required>
              <option value="">Select Department</option>
            </select>
                        <div id="departmentError" class="error-message hidden"></div>
          </div>

          <!-- Batch Selection -->
          <div class="form-group">
            <label for="batch" class="form-label">
              <i class="iconoir-group mr-2"></i>Batch
            </label>
            <select id="batch" name="batch" class="form-select" disabled required>
              <option value="">Select Batch</option>
            </select>
            <div id="batchError" class="error-message hidden"></div>
          </div>

          <!-- Subject Selection -->
          <div class="form-group">
            <label for="subject" class="form-label">
              <i class="iconoir-book mr-2"></i>Subject
            </label>
            <select id="subject" name="subject" class="form-select" disabled required>
              <option value="">Select Subject</option>
            </select>
            <div id="subjectError" class="error-message hidden"></div>
          </div>

          <!-- Section -->
          <div class="form-group">
            <label for="section" class="form-label">
              <i class="iconoir-user-circle mr-2"></i>Section
            </label>
            <select id="section" name="section" class="form-select" required>
              <option value="A">Section A</option>
              <option value="B">Section B</option>
              <option value="C">Section C</option>
            </select>
          </div>

          <!-- Time Slot Display -->
          <div class="form-group md:col-span-2">
            <label class="form-label">
              <i class="iconoir-clock mr-2"></i>Current Time Slot
            </label>
            <div id="timeSlotDisplay" class="time-display">
              Loading current time slot...
            </div>
            <input type="hidden" id="timeSlot" name="time_slot" value="">
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-8">
          <button type="submit" id="submitBtn" class="btn-primary" disabled>
            <i class="iconoir-check mr-2"></i>
            Mark Attendance
          </button>
        </div>

        <!-- Messages -->
        <div id="formMessages" class="mt-6 text-center hidden">
          <div id="successMessage" class="success-message hidden"></div>
          <div id="errorMessage" class="error-message hidden"></div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('department');
    const batchSelect = document.getElementById('batch');
    const subjectSelect = document.getElementById('subject');
    const timeSlotDisplay = document.getElementById('timeSlotDisplay');
    const timeSlotInput = document.getElementById('timeSlot');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('attendanceForm');

    // API endpoints
    const API_BASE = '/api/attendance-form/';

    // Utility functions
    function showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    }

    function hideError(elementId) {
        document.getElementById(elementId).style.display = 'none';
    }

    function resetSelect(select, placeholder) {
        select.innerHTML = `<option value="">${placeholder}</option>`;
        select.disabled = true;
    }

    function enableSelect(select) {
        select.disabled = false;
    }

    function updateSubmitButton() {
        const isValid = departmentSelect.value && 
                       batchSelect.value && 
                       subjectSelect.value && 
                       timeSlotInput.value;
        submitBtn.disabled = !isValid;
    }

    // Load departments on page load
    async function loadDepartments() {
        try {
            const response = await fetch(`${API_BASE}?action=departments`);
            const data = await response.json();
            
            if (data.error) {
                showError('departmentError', data.error);
                return;
            }

            data.departments.forEach(dept => {
                const option = new Option(dept, dept);
                departmentSelect.appendChild(option);
            });
            
            enableSelect(departmentSelect);
        } catch (error) {
            showError('departmentError', 'Failed to load departments');
            console.error('Error loading departments:', error);
        }
    }

    // Load batches when department changes
    async function loadBatches(deptName) {
        resetSelect(batchSelect, 'Select Batch');
        resetSelect(subjectSelect, 'Select Subject');
        hideError('batchError');
        hideError('subjectError');
        updateSubmitButton();

        if (!deptName) return;

        try {
            batchSelect.innerHTML = '<option value="">Loading...</option>';
            
            const response = await fetch(`${API_BASE}?action=batches&dept_name=${encodeURIComponent(deptName)}`);
            const data = await response.json();
            
            if (data.error) {
                showError('batchError', data.error);
                resetSelect(batchSelect, 'Select Batch');
                return;
            }

            resetSelect(batchSelect, 'Select Batch');
            data.batches.forEach(batch => {
                const option = new Option(batch.display_year, batch.batch_year);
                batchSelect.appendChild(option);
            });
            
            enableSelect(batchSelect);
        } catch (error) {
            showError('batchError', 'Failed to load batches');
            resetSelect(batchSelect, 'Select Batch');
            console.error('Error loading batches:', error);
        }
    }

    // Load subjects when batch changes
    async function loadSubjects(deptName, batchYear) {
        resetSelect(subjectSelect, 'Select Subject');
        hideError('subjectError');
        updateSubmitButton();

        if (!deptName || !batchYear) return;

        try {
            subjectSelect.innerHTML = '<option value="">Loading...</option>';
            
            const response = await fetch(`${API_BASE}?action=subjects&dept_name=${encodeURIComponent(deptName)}&batch_year=${encodeURIComponent(batchYear)}`);
            const data = await response.json();
            
            if (data.error) {
                showError('subjectError', data.error);
                resetSelect(subjectSelect, 'Select Subject');
                return;
            }

            resetSelect(subjectSelect, 'Select Subject');
            data.subjects.forEach(subject => {
                const option = new Option(`${subject.subject_code} - ${subject.subject_name}`, subject.subject_code);
                subjectSelect.appendChild(option);
            });
            
            enableSelect(subjectSelect);
        } catch (error) {
            showError('subjectError', 'Failed to load subjects');
            resetSelect(subjectSelect, 'Select Subject');
            console.error('Error loading subjects:', error);
        }
    }

    // Load current time slot
    async function loadCurrentTimeSlot(batchYear) {
        if (!batchYear) {
            timeSlotDisplay.textContent = 'Select a batch to see time slot';
            timeSlotInput.value = '';
            updateSubmitButton();
            return;
        }

        try {
            timeSlotDisplay.textContent = 'Loading time slot...';
            
            const response = await fetch(`${API_BASE}?action=current_time_slot&batch_year=${encodeURIComponent(batchYear)}`);
            const data = await response.json();
            
            if (data.error) {
                timeSlotDisplay.textContent = `Error: ${data.error}`;
                timeSlotInput.value = '';
                updateSubmitButton();
                return;
            }

            if (data.current_time_slot) {
                const slot = data.current_time_slot;
                timeSlotDisplay.innerHTML = `
                    <i class="iconoir-clock mr-2"></i>
                    Block ${slot.block_number}: ${slot.start_time} - ${slot.end_time}
                    <span class="ml-2 px-2 py-1 rounded text-xs ${slot.status === 'active' ? 'bg-green-500' : 'bg-yellow-500'} text-white">
                        ${slot.status === 'active' ? 'ACTIVE' : 'UPCOMING'}
                    </span>
                `;
                timeSlotInput.value = slot.block_number;
            } else {
                timeSlotDisplay.innerHTML = `
                    <i class="iconoir-info-circle mr-2"></i>
                    No active or upcoming classes
                    <span class="ml-2 text-xs">(Current time: ${data.current_time})</span>
                `;
                timeSlotInput.value = '';
            }
            
            updateSubmitButton();
        } catch (error) {
            timeSlotDisplay.textContent = 'Failed to load time slot';
            timeSlotInput.value = '';
            updateSubmitButton();
            console.error('Error loading time slot:', error);
        }
    }

    // Event listeners
    departmentSelect.addEventListener('change', function() {
        hideError('departmentError');
        loadBatches(this.value);
    });

    batchSelect.addEventListener('change', function() {
        hideError('batchError');
        loadSubjects(departmentSelect.value, this.value);
        loadCurrentTimeSlot(this.value);
    });

    subjectSelect.addEventListener('change', function() {
        hideError('subjectError');
        updateSubmitButton();
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            dept_name: departmentSelect.value,
            batch_year: batchSelect.value,
            subject: subjectSelect.value,
            section: document.getElementById('section').value,
            time_slot: timeSlotInput.value
        };

        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="iconoir-refresh-double animate-spin mr-2"></i>Processing...';
            
            const response = await fetch(API_BASE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            
            if (data.error) {
                document.getElementById('errorMessage').textContent = data.error;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
            } else {
                document.getElementById('successMessage').textContent = data.message || 'Attendance marked successfully!';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                
                // Optionally reset form or redirect
                // form.reset();
            }
            
            document.getElementById('formMessages').style.display = 'block';
            
        } catch (error) {
            document.getElementById('errorMessage').textContent = 'Failed to submit attendance form';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('formMessages').style.display = 'block';
            console.error('Error submitting form:', error);
        } finally {
            submitBtn.innerHTML = '<i class="iconoir-check mr-2"></i>Mark Attendance';
            updateSubmitButton();
        }
    });

    // Initialize
    loadDepartments();
});
</script>
{% endblock %}
