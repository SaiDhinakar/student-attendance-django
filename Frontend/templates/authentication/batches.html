{% extends 'base.html' %}
{% block title %}Batches - Student Attendance{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-2xl font-bold text-primary-custom">Batches</h1>
    <p class="text-secondary-custom">Manage all batches and their schedules</p>
  </div>
  <button onclick="openModal('addBatchModal')" class="btn-primary flex items-center gap-2">
    <i class="iconoir-plus"></i>
    Add Batch
  </button>
</div>

<!-- Search and Filter -->
<div class="card mb-6">
  <div class="flex flex-col sm:flex-row gap-4">
    <div class="flex-1">
      <input type="text" id="searchBatches" placeholder="Search batches..." class="form-input w-full">
    </div>
    <select id="departmentFilter" class="form-input">
      <option value="">All Departments</option>
      {% for department in departments %}
      <option value="{{ department.name }}">{{ department.name }}</option>
      {% endfor %}
    </select>
    <select id="statusFilter" class="form-input">
      <option value="">All Status</option>
      <option value="Active">Active</option>
      <option value="Completed">Completed</option>
      <option value="Upcoming">Upcoming</option>
    </select>
  </div>
</div>

<!-- Batches Table -->
<div class="card overflow-hidden p-0">
  <table class="min-w-full divide-y divide-primary">
    <thead class="table-header">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Batch Name</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Year/Semester</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Students</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Start Date</th>
        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200" id="batchesTableBody">
      {% for batch in batches %}
      <tr class="hover:bg-gray-50" data-department="{{ batch.department.name }}" data-status="{{ batch.get_status_display }}">
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <div class="h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <span class="text-blue-600 font-semibold text-sm">{{ batch.name|slice:":4" }}</span>
            </div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">{{ batch.name }}</div>
              <div class="text-sm text-gray-500">{{ batch.department.name }}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.department.name }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.year }} / {{ batch.semester }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.student_set.count }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ batch.created_at|date:"M d, Y" }}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          {% if batch.is_active %}
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>
          {% else %}
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>
          {% endif %}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          <div class="flex items-center gap-2">
            <button onclick="openModal('editBatchModal')" class="text-blue-600 hover:text-blue-900">Edit</button>
            <button class="text-red-600 hover:text-red-900">Delete</button>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="px-6 py-4 text-center text-gray-500">No batches found</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Add Batch Modal -->
<div id="addBatchModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg w-full max-w-md">
      <div class="flex justify-between items-center p-6 border-b">
        <h3 class="text-lg font-semibold">Add New Batch</h3>
        <button onclick="closeModal('addBatchModal')" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Batch Name</label>
          <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="e.g., CS Batch 2024">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
          <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            <option>Select Department</option>
            {% for department in departments %}
            <option value="{{ department.name }}">{{ department.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option>1st Year</option>
              <option>2nd Year</option>
              <option>3rd Year</option>
              <option>4th Year</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option>1st Sem</option>
              <option>2nd Sem</option>
              <option>3rd Sem</option>
              <option>4th Sem</option>
              <option>5th Sem</option>
              <option>6th Sem</option>
              <option>7th Sem</option>
              <option>8th Sem</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
          <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Expected Students</label>
          <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="50">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeModal('addBatchModal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Batch</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Batch Modal -->
<div id="editBatchModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg w-full max-w-md">
      <div class="flex justify-between items-center p-6 border-b">
        <h3 class="text-lg font-semibold">Edit Batch</h3>
        <button onclick="closeModal('editBatchModal')" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Batch Name</label>
          <input type="text" value="CS Batch 2024" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
          <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            {% for department in departments %}
            <option value="{{ department.name }}">{{ department.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option>1st Year</option>
              <option>2nd Year</option>
              <option selected>3rd Year</option>
              <option>4th Year</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option>1st Sem</option>
              <option>2nd Sem</option>
              <option>3rd Sem</option>
              <option>4th Sem</option>
              <option selected>5th Sem</option>
              <option>6th Sem</option>
              <option>7th Sem</option>
              <option>8th Sem</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
          <input type="date" value="2024-08-15" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Current Students</label>
          <input type="number" value="45" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            <option selected>Active</option>
            <option>Completed</option>
            <option>Upcoming</option>
          </select>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeModal('editBatchModal')" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Update Batch</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchBatches');
  const departmentFilter = document.getElementById('departmentFilter');
  const statusFilter = document.getElementById('statusFilter');
  const tableBody = document.getElementById('batchesTableBody');
  const rows = tableBody.querySelectorAll('tr');

  function filterBatches() {
    const searchTerm = searchInput.value.toLowerCase();
    const departmentValue = departmentFilter.value.toLowerCase();
    const statusValue = statusFilter.value.toLowerCase();

    rows.forEach(row => {
      const batchName = row.querySelector('.text-sm.font-medium')?.textContent.toLowerCase() || '';
      const department = row.dataset.department?.toLowerCase() || '';
      const status = row.dataset.status?.toLowerCase() || '';

      const matchesSearch = batchName.includes(searchTerm);
      const matchesDepartment = !departmentValue || department.includes(departmentValue);
      const matchesStatus = !statusValue || status.includes(statusValue);

      if (matchesSearch && matchesDepartment && matchesStatus) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  searchInput.addEventListener('input', filterBatches);
  departmentFilter.addEventListener('change', filterBatches);
  statusFilter.addEventListener('change', filterBatches);
});
</script>
{% endblock %}
